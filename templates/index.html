<!DOCTYPE html>
<html>
<head>
    <title>Basketball Parser</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container { 
            max-width: 1800px; 
            margin: 0 auto; 
            background: rgba(255, 255, 255, 0.95); 
            padding: 20px; 
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.2em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
            margin-right: 20px;
        }

        .nav-links a {
            text-decoration: none;
            color: #2c3e50;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            background: #f8f9fa;
        }

        .nav-links a.active {
            background: #667eea;
            color: white;
        }
        
        .stats { 
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(116, 185, 255, 0.3);
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        small {
            font-size: 12px;
            opacity: 0.9;
            font-weight: 600;
        }        
        th, td { 
            padding: 14px 12px; 
            text-align: left; 
            border-bottom: 1px solid #e9ecef;
            font-size: 16px;
        }
        
        th { 
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 0.5px;
        }
        
        tr:hover {
            background-color: #f8f9fa;
            transform: translateY(-1px);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        /* –¶–≤–µ—Ç–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã –¥–ª—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π */
        .positive { 
            color: #00b894; 
            font-weight: bold;
            background: rgba(0, 184, 148, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .negative { 
            color: #e17055; 
            font-weight: bold;
            background: rgba(225, 112, 85, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .neutral { 
            color: #636e72; 
            background: rgba(99, 110, 114, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .loading { 
            text-align: center; 
            padding: 40px; 
            color: #6c757d;
            font-size: 18px;
        }
        
        .match-teams {
            font-weight: 600;
            color: #2d3436;
            font-size: 14px;
        }
        
        .tournament {
            color: #636e72;
            font-size: 12px;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –≥—Ä–∞—Ñ–∏–∫–æ–º */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 1400px;  /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –º–æ–¥–∞–ª–∫–∏ */
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }       
        .close:hover {
            color: black;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ - –û–°–ù–û–í–ù–û–ô –†–ê–ó–ú–ï–† –ì–†–ê–§–ò–ö–ê */
        .chart-container {
            position: relative;
            height: 525px;  /* –í—ã—Å–æ—Ç–∞ –≥—Ä–∞—Ñ–∏–∫–∞ */
            width: 100%;
            margin: 20px 0;
        }
        
        .chart-title {
            text-align: center;
            margin: 10px 0;
            font-size: 20px;
            font-weight: bold;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ —Ç–∞–±–ª–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        .change-indicator {
            position: fixed; /* ‚Üê –ú–µ–Ω—è–µ–º –Ω–∞ fixed */
            top: 50%; /* ‚Üê –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
            left: 50%; /* ‚Üê –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ */
            transform: translate(-50%, -50%) scale(0.8); /* ‚Üê –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ */
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #667eea;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 10000; /* ‚Üê –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º z-index */
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
            min-width: 200px;
        }

        .change-indicator.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .change-content {
            text-align: center;
        }

        .change-header {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .change-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .change-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }

        .change-label {
            font-weight: 600;
            color: #5d6d7e;
            font-size: 14px;
        }

        .change-value {
            font-weight: bold;
            color: #2c3e50;
            font-size: 14px;
        }

        .change-diff {
            font-weight: bold;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 40px;
            text-align: center;
        }

        .change-diff.positive {
            background: rgba(0, 184, 148, 0.2);
            color: #00b894;
        }

        .change-diff.negative {
            background: rgba(225, 112, 85, 0.2);
            color: #e17055;
        }

        .change-diff.neutral {
            background: rgba(99, 110, 114, 0.2);
            color: #636e72;
        }
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 1200px) {
            .container {
                margin: 10px;
                padding: 15px;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 10px 8px;
            }
            
            .modal-content {
                width: 95%;
                margin: 2% auto;
            }
        }
        
        @media (max-width: 768px) {
            .container { margin: 5px; padding: 10px; }
            table { font-size: 12px; }
            th, td { padding: 8px 4px; }
            .nav-links { flex-direction: column; gap: 10px; }
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –≤—Å–µ–π —Å—Ç—Ä–æ–∫–∏ - –Ø–†–ß–ï */
        .row-positive { 
            background: rgba(0, 184, 148, 0.15) !important; 
            border-left: 4px solid #00b894;
        }

        .row-negative { 
            background: rgba(225, 112, 85, 0.15) !important; 
            border-left: 4px solid #e17055;
        }

        /* –Ø–í–ù–û —É–∫–∞–∑—ã–≤–∞–µ–º —Ü–≤–µ—Ç–∞ –ø—Ä–∏ —Ö–æ–≤–µ—Ä–µ –¥–ª—è –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ */
        table tr.row-positive:hover {
            background: rgba(0, 184, 148, 0.25) !important; /* –Ø—Ä—á–µ –ø—Ä–∏ —Ö–æ–≤–µ—Ä–µ */
            transform: none !important;
        }

        table tr.row-negative:hover {
            background: rgba(225, 112, 85, 0.25) !important; /* –Ø—Ä—á–µ –ø—Ä–∏ —Ö–æ–≤–µ—Ä–µ */
            transform: none !important;
        }

        /* –û–±—ã—á–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ */
        table tr:hover:not(.row-positive):not(.row-negative) {
            background-color: #f8f9fa;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÄ Basketball Parser Live</h1>
            <div class="nav-links">
                <a href="/" class="active">üìä Live –º–∞—Ç—á–∏</a>
                <a href="/archive">üìÅ –ê—Ä—Ö–∏–≤</a>
            </div>
            <div class="stats" id="stats">
                –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
            </div>
        </div>

        <div id="matches-table">
            <div class="loading">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –º–∞—Ç—á–µ–π...</div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ -->
    <div id="chartModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="chartTitle" class="chart-title"></div>
            <div class="chart-container">
                <canvas id="matchChart"></canvas>
            </div>
        </div>
    </div>
    <div id="changeIndicator" class="change-indicator">
        <div class="change-content">
            <div class="change-header">üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</div>
            <div class="change-stats">
                <div class="change-item">
                    <span class="change-label">–û—á–∫–∏:</span>
                    <span class="change-value" id="changePoints">0</span>
                    <span class="change-diff" id="changePointsDiff">+0</span>
                </div>
                <div class="change-item">
                    <span class="change-label">–¢–µ–º–ø:</span>
                    <span class="change-value" id="changePace">0</span>
                    <span class="change-diff" id="changePaceDiff">+0</span>
                </div>
                <div class="change-item">
                    <span class="change-label">–¢–æ—Ç–∞–ª:</span>
                    <span class="change-value" id="changeTotal">0</span>
                    <span class="change-diff" id="changeTotalDiff">+0</span>
                </div>
            </div>
        </div>
    </div>
    <script>
        let currentChart = null;
        let wsConnected = false;
        window.wsConnected = false;
        let currentOpenMatchId = null;

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        const modal = document.getElementById('chartModal');
        const closeBtn = document.querySelector('.close');

        closeBtn.onclick = function() {
            modal.style.display = 'none';
            if (currentChart) {
                currentChart.destroy();
                currentChart = null;
            }
            currentOpenMatchId = null;
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
                if (currentChart) {
                    currentChart.destroy();
                    currentChart = null;
                }
                currentOpenMatchId = null;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –º–∏–Ω—É—Ç –º–∞—Ç—á–∞ –∏–∑ –≤—Ä–µ–º–µ–Ω–∏
        function calculateMinutesElapsed(currentTime) {
            if (!currentTime || currentTime === '-') return 0;
            try {
                const parts = currentTime.split(':');
                if (parts.length < 2) return 0;
                const minutes = parseInt(parts[0]) || 0;
                const seconds = parseInt(parts[1]) || 0;
                return minutes + (seconds / 60);
            } catch (error) {
                return 0;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –º–∞—Ç—á–µ–π
        function updateTable(matches) {
            console.log('üîÑ updateTable called with', matches?.length, 'matches');
            
            if (!matches || matches.length === 0) {
                document.getElementById('matches-table').innerHTML = 
                    '<div class="loading">üì≠ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—Ç—á–µ–π –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç</div>';
                document.getElementById('stats').innerHTML = 
                    '–ú–∞—Ç—á–µ–π: 0 | –û–±–Ω–æ–≤–ª–µ–Ω–æ: ' + new Date().toLocaleTimeString();
                return;
            }

            document.getElementById('stats').innerHTML = 
                `üìä –ú–∞—Ç—á–µ–π: ${matches.length} | üîÑ ${new Date().toLocaleTimeString()}`;
            const sortedMatches = [...matches].sort((a, b) => {
                return (a.tournament || '–ë–µ–∑ —Ç—É—Ä–Ω–∏—Ä–∞').localeCompare(b.tournament || '–ë–µ–∑ —Ç—É—Ä–Ω–∏—Ä–∞');
            });
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>–ö–æ–º–∞–Ω–¥—ã / –¢—É—Ä–Ω–∏—Ä</th>
                            <th>–í—Ä–µ–º—è</th>
                            <th>–°—á–µ—Ç</th>
                            <th>–û—á–∫–∏</th>
                            <th>–ù–∞—á. —Ç–æ—Ç–∞–ª</th>
                            <th>–¢–µ–∫. —Ç–æ—Ç–∞–ª</th>
                            <th>Œî –¢–æ—Ç–∞–ª–∞</th>
                            <th>–¢–µ–º–ø</th>
                            <th>–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedMatches.forEach(match => {
                // –†–∞—Å—á–µ—Ç minutes_elapsed –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                if (!match.minutes_elapsed && match.current_time && match.current_time !== '-') {
                    match.minutes_elapsed = calculateMinutesElapsed(match.current_time);
                }
                
                const deviationClass = getDeviationClass(match.total_deviation);
                
                html += `
                    <tr class="${match.initial_total && match.total_value ? getTotalDiffClass(match.total_value - match.initial_total, ((match.total_value - match.initial_total) / match.initial_total * 100)) : ''}" onclick="showMatchChart(${match.id}, '${escapeHtml(match.teams)}')">
                        <td>
                            <div class="match-teams">${match.teams}</div>
                            <div class="tournament">${match.tournament}</div>
                        </td>
                        <td><strong>${match.current_time}</strong></td>
                        <td><strong>${match.score}</strong></td>
                        <td>${match.total_points}</td>
                        <td>${match.initial_total || '-'}</td>
                        <td>${match.total_value || '-'}</td>
                        <td>
                            ${match.initial_total && match.total_value ? 
                                `<span class="${getCellDiffClass((match.total_value - match.initial_total) / match.initial_total * 100)}">
                                    ${(match.total_value - match.initial_total).toFixed(1)} 
                                    (${((match.total_value - match.initial_total) / match.initial_total * 100).toFixed(1)}%)
                                </span>` 
                                : '-'
                            }
                        </td>                      
                        <td>${match.current_pace || '-'}</td>
                        <td>
                            <span class="${deviationClass}">
                                ${match.total_deviation ? `${match.total_deviation > 0 ? '+' : ''}${match.total_deviation}%` : '-'}
                            </span>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('matches-table').innerHTML = html;
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function getDeviationClass(deviation) {
            if (!deviation) return 'neutral';
            if (deviation > 5) return 'positive';
            if (deviation < -5) return 'negative';
            return 'neutral';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è live-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            const socket = new WebSocket(wsUrl);
            
            socket.onopen = function() {
                console.log('‚úÖ WebSocket connected');
                wsConnected = true;
                window.wsConnected = true;
                document.getElementById('stats').innerHTML = 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ | –û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...';
            };
            
            socket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === "table_update") {
                        updateTable(data.data.matches);
                        updateOpenChart(data.data.matches);
                    }
                } catch (error) {
                    console.error('‚ùå Error parsing WebSocket message:', error);
                }
            };

            socket.onclose = function() {
                console.log('‚ùå WebSocket disconnected');
                wsConnected = false;
                window.wsConnected = false;
                document.getElementById('stats').innerHTML = 'üü° –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                setTimeout(connectWebSocket, 5000);
            };

            socket.onerror = function(error) {
                console.error('‚ùå WebSocket error:', error);
            };
        }
        function getTotalDiffClass(diff, percent) {
            if (!diff || diff === 0) return '';
            
            if (percent < -10) return 'row-negative';    // üî¥ –í—Å—è —Å—Ç—Ä–æ–∫–∞ –∫—Ä–∞—Å–Ω–∞—è
            if (percent > 10) return 'row-positive';     // üü¢ –í—Å—è —Å—Ç—Ä–æ–∫–∞ –∑–µ–ª–µ–Ω–∞—è
            return '';                                   // ‚ö™ –ë–µ–∑ –ø–æ–¥—Å–≤–µ—Ç–∫–∏
        }
        function getCellDiffClass(percent) {
            if (!percent) return 'neutral';
            if (percent < -10) return 'negative';
            if (percent > 10) return 'positive';
            return 'neutral';
        }
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–µ–≥–µ–Ω–¥—ã –≥—Ä–∞—Ñ–∏–∫–∞
        function updateLegendLabels(chart) {
            const datasets = chart.data.datasets;
            return datasets.map((dataset, index) => {
                let label = dataset.originalLabel || dataset.label || '';
                
                return {
                    text: label,
                    fillStyle: dataset.borderColor,
                    strokeStyle: dataset.borderColor,
                    lineWidth: 2,
                    pointStyle: dataset.pointStyle,
                    hidden: !chart.isDatasetVisible(index),
                    index: index
                };
            });
        }

        function updateDatasetLabels(chart) {
            if (!chart || !chart.data || !chart.data.datasets) return;
            
            chart.data.datasets.forEach((dataset, index) => {
                dataset.label = dataset.originalLabel || dataset.label || '';
            });
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
        function updateOpenChart(matches) {
            if (!currentOpenMatchId || !currentChart) return;
            
            const currentMatch = matches.find(match => match.id === currentOpenMatchId);
            if (currentMatch) {
                // –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
                fetch(`/api/matches/${currentOpenMatchId}/chart`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data.error) {
                            refreshChart(data);
                        }
                    })
                    .catch(error => console.error('‚ùå Error updating chart:', error));
            }
        }

        function refreshChart(newData) {
            if (!currentChart || !newData.timestamps) return;
            
            // –ü–û–ö–ê–ó–´–í–ê–ï–ú –ò–ù–î–ò–ö–ê–¢–û–† –ò–ó–ú–ï–ù–ï–ù–ò–ô
            showChangesIndicator(newData);            
            window.currentChartData = newData;
            
            // –ù–∞—Ö–æ–¥–∏–º –Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –º–∏–Ω/–º–∞–∫—Å —Ç–æ—Ç–∞–ª–∞
            const totalValues = newData.total_values.filter(val => val !== null && val !== undefined);
            const maxTotal = totalValues.length > 0 ? Math.max(...totalValues) : null;
            const minTotal = totalValues.length > 0 ? Math.min(...totalValues) : null;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            currentChart.data.labels = newData.timestamps;
            currentChart.data.datasets[0].data = newData.total_points;
            currentChart.data.datasets[1].data = newData.total_values;
            currentChart.data.datasets[2].data = newData.pace_data;
            
            // –û–ë–ù–û–í–õ–Ø–ï–ú –õ–ò–ù–ò–ò –ú–ò–ù/–ú–ê–ö–° –¢–û–¢–ê–õ–ê
            if (maxTotal && currentChart.data.datasets[3]) {
                currentChart.data.datasets[3].data = newData.timestamps.map(() => maxTotal);
                currentChart.data.datasets[3].label = `–ú–∞–∫—Å. —Ç–æ—Ç–∞–ª: ${maxTotal}`;
            }
            
            if (minTotal && currentChart.data.datasets[4]) {
                currentChart.data.datasets[4].data = newData.timestamps.map(() => minTotal);
                currentChart.data.datasets[4].label = `–ú–∏–Ω. —Ç–æ—Ç–∞–ª: ${minTotal}`;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º labels –≤ datasets
            updateDatasetLabels(currentChart);
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
            currentChart.update('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            updateChartTitleFromData(newData);
        }

        function updateChartTitleFromData(chartData) {
            if (!chartData.timestamps || chartData.timestamps.length === 0) return;
            
            const lastIndex = chartData.timestamps.length - 1;
            const currentValues = {
                totalPoints: chartData.total_points[lastIndex] || '-',
                totalValue: chartData.total_values[lastIndex] || '-',
                pace: chartData.pace_data[lastIndex] || '-',
                timestamp: chartData.timestamps[lastIndex] || '-',
                score: chartData.scores ? chartData.scores[lastIndex] : '-'
            };
            
            // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ç–æ—Ç–∞–ª
            const totalValues = chartData.total_values.filter(val => val !== null && val !== undefined);
            const maxTotal = totalValues.length > 0 ? Math.max(...totalValues) : null;
            
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –¥–∞–Ω–Ω—ã—Ö
            const initialTotal = chartData.initial_total || (chartData.total_values && chartData.total_values[0]);
            const currentTotal = chartData.total_values && chartData.total_values[lastIndex];
            
            let totalDiffHtml = '';
            if (initialTotal && currentTotal) {
                const totalDiff = (currentTotal - initialTotal).toFixed(1);
                const totalDiffPercent = ((currentTotal - initialTotal) / initialTotal * 100).toFixed(1);
                totalDiffHtml = `üíπ Œî –¢–æ—Ç–∞–ª–∞: <strong>${totalDiff > 0 ? '+' : ''}${totalDiff} (${totalDiffPercent > 0 ? '+' : ''}${totalDiffPercent}%)</strong>`;
            }
            
            let maxTotalHtml = '';
            if (maxTotal) {
                maxTotalHtml = `üìà –ú–∞–∫—Å. —Ç–æ—Ç–∞–ª: <strong>${maxTotal.toFixed(1)}</strong>`;
            }
            
            const chartTitle = document.getElementById('chartTitle');
            if (chartTitle && currentOpenMatchId) {
                const matchInfo = getMatchInfoByMatchId(currentOpenMatchId);
                chartTitle.innerHTML = `
                    <div style="text-align: center; padding: 5px 0;">
                        <div style="font-size: 20px; font-weight: bold; color: #2c3e50; margin-bottom: 3px;">
                            ${matchInfo.teams}
                        </div>
                        <div style="font-size: 14px; color: #5d6d7e; margin-bottom: 4px;">
                            ${matchInfo.tournament} 
                        </div>
                        <div style="font-size: 16px; color: #7f8c8d; background: #f8f9fa; padding: 6px 12px; border-radius: 12px; margin-bottom: 3px;">
                            ‚è±Ô∏è ${currentValues.timestamp} | üìä ${currentValues.score}
                        </div>
                        <div style="font-size: 16px; color: #2c3e50; background: #e8f4fd; padding: 4px 10px; border-radius: 8px; margin-top: 2px;">
                            üèÄ –û—á–∫–∏: <strong>${currentValues.totalPoints}</strong> | 
                            üìà –¢–æ—Ç–∞–ª: <strong>${currentValues.totalValue}</strong> |
                            ‚ö° –¢–µ–º–ø: <strong>${currentValues.pace}</strong> |
                            ${totalDiffHtml} |
                            ${maxTotalHtml}
                        </div>
                    </div>
                `;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–∞—Ç—á–µ
        function getMatchInfoByMatchId(matchId) {
            // –ò—â–µ–º –º–∞—Ç—á –≤ —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü—ã
            const rows = document.querySelectorAll('#matches-table tbody tr');
            for (let row of rows) {
                const onclickAttr = row.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes(`showMatchChart(${matchId},`)) {
                    const matchTeams = row.querySelector('.match-teams');
                    const tournamentElement = row.querySelector('.tournament');
                    const timeElement = row.querySelector('td:nth-child(2) strong');
                    const scoreElement = row.querySelector('td:nth-child(3) strong');
                    
                    return {
                        tournament: tournamentElement ? tournamentElement.textContent : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç—É—Ä–Ω–∏—Ä',
                        currentTime: timeElement ? timeElement.textContent : '-',
                        teams: matchTeams ? matchTeams.textContent : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã',
                        score: scoreElement ? scoreElement.textContent : '-'
                    };
                }
            }
            
            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            return {
                tournament: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç—É—Ä–Ω–∏—Ä',
                currentTime: '-',
                teams: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã',
                score: '-'
            };
        }

        function showMatchChart(matchId, teams) {
            currentOpenMatchId = matchId;
            const matchInfo = getMatchInfoByMatchId(matchId);
            
            fetch(`/api/matches/${matchId}/chart`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    
                    document.getElementById('chartTitle').innerHTML = `
                        <div style="text-align: center; padding: 5px 0;">
                            <div style="font-size: 20px; font-weight: bold; color: #2c3e50; margin-bottom: 3px;">
                                ${teams}
                            </div>
                            <div style="font-size: 15px; color: #5d6d7e; margin-bottom: 4px;">
                                ${matchInfo.tournament}
                            </div>
                            <div style="font-size: 14px; color: #7f8c8d; background: #f8f9fa; padding: 4px 12px; border-radius: 12px; display: inline-block;">
                                ‚è±Ô∏è –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: <strong>${matchInfo.currentTime}</strong>
                            </div>
                        </div>
                    `;
                    
                    createChart(data, teams, matchInfo.tournament, matchInfo.currentTime);
                    modal.style.display = 'block';
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞');
                });
        }

        function createChart(chartData, teams, tournament, currentTime) {
            const ctx = document.getElementById('matchChart').getContext('2d');
            if (currentChart) currentChart.destroy();
            
            window.currentChartData = chartData;
            
            // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ç–æ—Ç–∞–ª
            const totalValues = chartData.total_values.filter(val => val !== null && val !== undefined);
            const maxTotal = totalValues.length > 0 ? Math.max(...totalValues) : null;
            const minTotal = totalValues.length > 0 ? Math.min(...totalValues) : null;
            
            previousChartData = null;
            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.timestamps,
                    datasets: [
                        {
                            label: '–û—á–∫–∏',
                            originalLabel: '–û—á–∫–∏',
                            data: chartData.total_points,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: '–õ–∏–Ω–∏—è —Ç–æ—Ç–∞–ª–∞',
                            originalLabel: '–õ–∏–Ω–∏—è —Ç–æ—Ç–∞–ª–∞',
                            data: chartData.total_values,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: '–¢–µ–º–ø –∏–≥—Ä—ã',
                            originalLabel: '–¢–µ–º–ø –∏–≥—Ä—ã',
                            data: chartData.pace_data,
                            borderColor: 'rgb(153, 102, 255)',
                            backgroundColor: 'rgba(153, 102, 255, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointStyle: 'circle',
                            pointRadius: 3,
                            fill: false
                        },
                        // –õ–∏–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Ç–æ—Ç–∞–ª–∞
                        {
                            label: `–ú–∞–∫—Å. —Ç–æ—Ç–∞–ª: ${maxTotal}`,
                            data: chartData.timestamps.map(() => maxTotal),
                            borderColor: 'rgba(231, 76, 60, 0.8)',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,           // –£–±–∏—Ä–∞–µ–º —Ç–æ—á–∫–∏
                            pointHoverRadius: 0,      // –£–±–∏—Ä–∞–µ–º —Ç–æ—á–∫–∏ –ø—Ä–∏ —Ö–æ–≤–µ—Ä–µ
                            pointHitRadius: 0,        // –£–±–∏—Ä–∞–µ–º –∑–æ–Ω—É –∫–ª–∏–∫–∞
                            fill: false
                        },
                        // –õ–∏–Ω–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ç–æ—Ç–∞–ª–∞
                        {
                            label: `–ú–∏–Ω. —Ç–æ—Ç–∞–ª: ${minTotal}`,
                            data: chartData.timestamps.map(() => minTotal),
                            borderColor: 'rgba(46, 204, 113, 0.8)',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,           // –£–±–∏—Ä–∞–µ–º —Ç–æ—á–∫–∏
                            pointHoverRadius: 0,      // –£–±–∏—Ä–∞–µ–º —Ç–æ—á–∫–∏ –ø—Ä–∏ —Ö–æ–≤–µ—Ä–µ
                            pointHitRadius: 0,        // –£–±–∏—Ä–∞–µ–º –∑–æ–Ω—É –∫–ª–∏–∫–∞
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { 
                            title: { 
                                display: true, 
                                text: '–í—Ä–µ–º—è –º–∞—Ç—á–∞',
                                font: { size: 14 }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            ticks: {
                                font: { size: 12 }
                            }
                        },
                        y: { 
                            title: { 
                                display: true, 
                                text: '–û—á–∫–∏ / –¢–µ–º–ø',
                                font: { size: 14 }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            ticks: {
                                font: { size: 12 }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    const timestamp = window.currentChartData.timestamps[index];
                                    const score = window.currentChartData.scores ? window.currentChartData.scores[index] : 'N/A';
                                    return `–í—Ä–µ–º—è: ${timestamp} | –°—á–µ—Ç: ${score}`;
                                },
                                label: function(context) {
                                    const datasetLabel = context.dataset.originalLabel || context.dataset.label || '';
                                    const value = context.parsed.y;
                                    
                                    if (datasetLabel === '–û—á–∫–∏') {
                                        return `–û—á–∫–∏: ${value}`;
                                    } else if (datasetLabel === '–õ–∏–Ω–∏—è —Ç–æ—Ç–∞–ª–∞') {
                                        return `–¢–æ—Ç–∞–ª: ${value}`;
                                    } else if (datasetLabel === '–¢–µ–º–ø –∏–≥—Ä—ã') {
                                        return `–¢–µ–º–ø: ${value}`;
                                    } else if (datasetLabel.includes('–ú–∞–∫—Å. —Ç–æ—Ç–∞–ª')) {
                                        return `–ú–∞–∫—Å. —Ç–æ—Ç–∞–ª: ${value}`;
                                    } else if (datasetLabel.includes('–ú–∏–Ω. —Ç–æ—Ç–∞–ª')) {
                                        return `–ú–∏–Ω. —Ç–æ—Ç–∞–ª: ${value}`;
                                    }
                                    return `${datasetLabel}: ${value}`;
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            align: 'center',
                            labels: {
                                generateLabels: updateLegendLabels,
                                font: {
                                    size: 14,
                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                },
                                padding: 20,
                                boxWidth: 15,
                                usePointStyle: true
                            }
                        }
                    },
                    animation: {
                        duration: 0
                    }
                }
            });
            
            updateDatasetLabels(currentChart);
            currentChart.update('active');
        }
        // –î–æ–±–∞–≤—å—Ç–µ –≤ –Ω–∞—á–∞–ª–æ —Å –¥—Ä—É–≥–∏–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
        let previousChartData = null;
        let changeIndicatorTimeout = null;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        function showChangesIndicator(newData) {
            if (!previousChartData || !newData.timestamps || newData.timestamps.length === 0) {
                previousChartData = JSON.parse(JSON.stringify(newData));
                return;
            }
            
            const newIndex = newData.timestamps.length - 1;
            const oldIndex = previousChartData.timestamps.length - 1;
            
            // –ï—Å–ª–∏ –Ω–µ—Ç —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –∏–Ω–¥–µ–∫—Å—ã –Ω–µ–≤–∞–ª–∏–¥–Ω—ã
            if (oldIndex < 0 || newIndex < 0) {
                previousChartData = JSON.parse(JSON.stringify(newData));
                return;
            }
            
            // –ï—Å–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç, –Ω–µ—Ç –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            if (newData.timestamps[newIndex] === previousChartData.timestamps[oldIndex]) {
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è (—Å –∑–∞—â–∏—Ç–æ–π –æ—Ç undefined)
            const newPoints = newData.total_points[newIndex] || 0;
            const newPace = newData.pace_data[newIndex] || 0;
            const newTotal = newData.total_values[newIndex] || 0;
            
            const oldPoints = previousChartData.total_points[oldIndex] || 0;
            const oldPace = previousChartData.pace_data[oldIndex] || 0;
            const oldTotal = previousChartData.total_values[oldIndex] || 0;
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            const pointsDiff = newPoints - oldPoints;
            const paceDiff = newPace - oldPace;
            const totalDiff = newTotal - oldTotal;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∑–Ω–∞—á–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            if (Math.abs(pointsDiff) > 0.1 || Math.abs(paceDiff) > 0.1 || Math.abs(totalDiff) > 0.1) {
                updateChangeIndicator({
                    points: { value: newPoints, diff: pointsDiff },
                    pace: { value: newPace, diff: paceDiff },
                    total: { value: newTotal, diff: totalDiff }
                });
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            previousChartData = JSON.parse(JSON.stringify(newData));
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
        function updateChangeIndicator(changes) {
            const indicator = document.getElementById('changeIndicator');
            const pointsElem = document.getElementById('changePoints');
            const paceElem = document.getElementById('changePace');
            const totalElem = document.getElementById('changeTotal');
            const pointsDiffElem = document.getElementById('changePointsDiff');
            const paceDiffElem = document.getElementById('changePaceDiff');
            const totalDiffElem = document.getElementById('changeTotalDiff');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
            pointsElem.textContent = changes.points.value.toFixed(1);
            paceElem.textContent = changes.pace.value.toFixed(1);
            totalElem.textContent = changes.total.value.toFixed(1);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–Ω–∏—Ü—ã —Å —Ü–≤–µ—Ç–∞–º–∏
            updateDiffElement(pointsDiffElem, changes.points.diff);
            updateDiffElement(paceDiffElem, changes.pace.diff);
            updateDiffElement(totalDiffElem, changes.total.diff);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            indicator.classList.add('show');
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
            if (changeIndicatorTimeout) {
                clearTimeout(changeIndicatorTimeout);
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            changeIndicatorTimeout = setTimeout(() => {
                indicator.classList.remove('show');
            }, 5000);
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ —Ä–∞–∑–Ω–∏—Ü—ã
        function updateDiffElement(element, diff) {
            const absDiff = Math.abs(diff);
            
            if (diff > 0) {
                element.textContent = `+${absDiff.toFixed(1)}`;
                element.className = 'change-diff positive';
            } else if (diff < 0) {
                element.textContent = `-${absDiff.toFixed(1)}`;
                element.className = 'change-diff negative';
            } else {
                element.textContent = '0.0';
                element.className = 'change-diff neutral';
            }
        }
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            fetch('/api/matches')
                .then(response => response.json())
                .then(data => updateTable(data.matches))
                .catch(error => {
                    console.error('‚ùå Initial load error:', error);
                    document.getElementById('matches-table').innerHTML = 
                        '<div class="loading">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
                });

            // –ü–æ–¥–∫–ª—é—á–∞–µ–º WebSocket –¥–ª—è live-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
            connectWebSocket();
        });
    </script>
</body>
</html>