<!DOCTYPE html>
<html>
<head>
    <title>Basketball Parser</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container { 
            max-width: 1800px; 
            margin: 0 auto; 
            background: rgba(255, 255, 255, 0.95); 
            padding: 20px; 
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.2em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
            margin-right: 20px;
        }

        .nav-links a {
            text-decoration: none;
            color: #2c3e50;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            background: #f8f9fa;
        }

        .nav-links a.active {
            background: #667eea;
            color: white;
        }
        
        .stats { 
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(116, 185, 255, 0.3);
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        small {
            font-size: 12px;
            opacity: 0.9;
            font-weight: 600;
        }        
        th, td { 
            padding: 14px 12px; 
            text-align: left; 
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }
        
        th { 
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        
        tr:hover {
            background-color: #f8f9fa;
            transform: translateY(-1px);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .positive { 
            color: #00b894; 
            font-weight: bold;
            background: rgba(0, 184, 148, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .negative { 
            color: #e17055; 
            font-weight: bold;
            background: rgba(225, 112, 85, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .neutral { 
            color: #636e72; 
            background: rgba(99, 110, 114, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .loading { 
            text-align: center; 
            padding: 40px; 
            color: #6c757d;
            font-size: 18px;
        }
        
        .match-teams {
            font-weight: 600;
            color: #2d3436;
        }
        
        .tournament {
            color: #636e72;
            font-size: 12px;
        }
        
        /* –°—Ç–∏–ª—ã –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 1400px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }       
        .close:hover {
            color: black;
        }
        
        .chart-container {
            position: relative;
            height: 600px;
            width: 100%;
            margin: 20px 0;
        }
        
        .chart-title {
            text-align: center;
            margin: 10px 0;
            font-size: 20px;
            font-weight: bold;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∞–∑ */
        .phase-analysis, .phase-over, .phase-under, .phase-waiting {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 12px;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }
        
        .phase-analysis { background: #e3f2fd; color: #1565c0; }
        .phase-over { background: #e8f5e8; color: #2e7d32; }
        .phase-under { background: #ffebee; color: #c62828; }
        .phase-waiting { background: #f5f5f5; color: #616161; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∏–≥–Ω–∞–ª–æ–≤ */
        .signal-strong, .signal-medium, .signal-weak, .signal-none {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 12px;
            display: inline-block;
            min-width: 70px;
            text-align: center;
        }
        
        .signal-strong { background: #4caf50; color: white; }
        .signal-medium { background: #ff9800; color: white; }
        .signal-weak { background: #f44336; color: white; }
        .signal-none { background: #9e9e9e; color: white; }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ */
        .confidence-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .confidence-high { background: linear-gradient(90deg, #4caf50, #8bc34a); }
        .confidence-medium { background: linear-gradient(90deg, #ff9800, #ffb74d); }
        .confidence-low { background: linear-gradient(90deg, #f44336, #ef5350); }

        /* –¶–≤–µ—Ç–æ–≤—ã–µ —Å—Ç–∞—Ç—É—Å—ã —Å—Ç—Ä–æ–∫ */
        .tr-quality { background: #f8fff8 !important; }
        .tr-caution { background: #fff8f0 !important; }
        .tr-avoid { background: #fff0f0 !important; }
        .tr-waiting { background: #f8f9fa !important; }

        @media (max-width: 1200px) {
            .container {
                margin: 10px;
                padding: 15px;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 10px 8px;
            }
            
            .modal-content {
                width: 95%;
                margin: 2% auto;
            }
        }
        
        @media (max-width: 768px) {
            .container { margin: 5px; padding: 10px; }
            table { font-size: 12px; }
            th, td { padding: 8px 4px; }
            .nav-links { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÄ Basketball Parser Live</h1>
            <div class="nav-links">
                <a href="/" class="active">üìä Live –º–∞—Ç—á–∏</a>
                <a href="/archive">üìÅ –ê—Ä—Ö–∏–≤</a>
            </div>
            <div class="stats" id="stats">
                –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
            </div>
        </div>

        <div id="matches-table">
            <div class="loading">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –º–∞—Ç—á–µ–π...</div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ -->
    <div id="chartModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="chartTitle" class="chart-title"></div>
            <div class="chart-container">
                <canvas id="matchChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let currentChart = null;
        let wsConnected = false;
        window.wsConnected = false;
        let currentOpenMatchId = null;

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        const modal = document.getElementById('chartModal');
        const closeBtn = document.querySelector('.close');

        closeBtn.onclick = function() {
            modal.style.display = 'none';
            if (currentChart) {
                currentChart.destroy();
                currentChart = null;
            }
            currentOpenMatchId = null;
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
                if (currentChart) {
                    currentChart.destroy();
                    currentChart = null;
                }
                currentOpenMatchId = null;
            }
        }

        // –°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞ –º–∞—Ç—á–µ–π
        class MatchAnalyzer {
            constructor() {
                this.patterns = {
                    ACCELERATION: 'acceleration',
                    DIVERGENCE: 'divergence', 
                    COMPRESSION: 'compression'
                };
            }

            // –≠–¢–ê–ü 1: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            analyzeContext(match) {
                const filters = {
                    tooEarly: match.minutes_elapsed < 8,  // –£–∂–µ—Å—Ç–æ—á–µ–Ω–æ: –±—ã–ª–æ 5
                    tooLate: match.minutes_elapsed > 32,  // –£–∂–µ—Å—Ç–æ—á–µ–Ω–æ: –±—ã–ª–æ 35
                    isBlowout: this.isBlowout(match.score),
                    unknownTournament: this.isUnknownTournament(match.tournament)
                };

                const failedFilters = Object.values(filters).filter(Boolean).length;
                
                return {
                    quality: failedFilters === 0 ? 'HIGH' : failedFilters <= 1 ? 'MEDIUM' : 'LOW',
                    failedFilters: Object.keys(filters).filter(key => filters[key])
                };
            }

            // –ë–ê–ó–û–í–´–ô –ê–ù–ê–õ–ò–ó –ü–û –û–¢–ö–õ–û–ù–ï–ù–ò–Æ (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞)
            analyzeByDeviation(match) {
                const deviation = match.total_deviation || 0;
                const minutes = match.minutes_elapsed || 0;
                
                // –£–∂–µ—Å—Ç–æ—á–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—é
                if (deviation > 20 && minutes > 10) {  // –£–∂–µ—Å—Ç–æ—á–µ–Ω–æ: –±—ã–ª–æ >15
                    return { patterns: ['strong_deviation'], confidence: 70 };
                }
                if (deviation > 15 && minutes > 8) {   // –£–∂–µ—Å—Ç–æ—á–µ–Ω–æ: –±—ã–ª–æ >10
                    return { patterns: ['medium_deviation'], confidence: 50 };
                }
                if (deviation > 10 && minutes > 6) {   // –£–∂–µ—Å—Ç–æ—á–µ–Ω–æ: –±—ã–ª–æ >5
                    return { patterns: ['weak_deviation'], confidence: 30 };
                }
                if (Math.abs(deviation) > 7 && minutes > 4) {  // –£–∂–µ—Å—Ç–æ—á–µ–Ω–æ: –±—ã–ª–æ >3
                    return { patterns: ['minimal_deviation'], confidence: 20 };
                }
                
                return { patterns: [], confidence: 0 };
            }

            // –≠–¢–ê–ü 2: –î–µ—Ç–µ–∫—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
            detectPatterns(match) {
                let patterns = [];
                let confidence = 0;

                const deviation = match.total_deviation || 0;
                const minutes = match.minutes_elapsed || 0;

                console.log(`üîç DetectPatterns –¥–ª—è "${match.teams}":`, {
                    deviation, minutes,
                    total_change: match.total_change_percent,
                    pace_change: match.pace_change_percent
                });

                // 1. –ë–ê–ó–û–í–´–ô –ê–ù–ê–õ–ò–ó –ü–û –û–¢–ö–õ–û–ù–ï–ù–ò–Æ
                const deviationAnalysis = this.analyzeByDeviation(match);
                patterns = patterns.concat(deviationAnalysis.patterns);
                confidence += deviationAnalysis.confidence;

                // 2. –ü–ê–¢–¢–ï–†–ù–´ (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –±–æ–Ω—É—Å—ã - —É–º–µ–Ω—å—à–µ–Ω—ã)
                if (this.detectAccelerationPattern(match)) {
                    patterns.push(this.patterns.ACCELERATION);
                    confidence += 10;  // –£–º–µ–Ω—å—à–µ–Ω–æ: –±—ã–ª–æ 15
                    console.log('‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω ACCELERATION');
                }

                if (this.detectDivergencePattern(match)) {
                    patterns.push(this.patterns.DIVERGENCE);
                    confidence += 7;   // –£–º–µ–Ω—å—à–µ–Ω–æ: –±—ã–ª–æ 10
                    console.log('‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω DIVERGENCE');
                }

                if (this.detectCompressionPattern(match)) {
                    patterns.push(this.patterns.COMPRESSION);
                    confidence += 5;   // –£–º–µ–Ω—å—à–µ–Ω–æ: –±—ã–ª–æ 8
                    console.log('‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω COMPRESSION');
                }

                // 3. –£–ë–†–ê–ù–´ –õ–ï–ì–ö–ò–ï –ë–û–ù–£–°–´
                // if (deviation > 5 && deviation < 25) { confidence += 8; }
                // if (minutes > 8 && minutes < 35) { confidence += 5; }

                // –ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ô –£–†–û–í–ï–ù–¨ –£–í–ï–†–ï–ù–ù–û–°–¢–ò –µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
                if (Math.abs(deviation) > 12 && confidence < 25) {  // –£–∂–µ—Å—Ç–æ—á–µ–Ω–æ: –±—ã–ª–æ >8
                    confidence = 25;
                    console.log('‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ >12%');
                }

                console.log(`üìä –ò—Ç–æ–≥: patterns=${patterns.length}, confidence=${confidence}`);
                return { patterns, confidence: Math.min(confidence, 95) };
            }

            // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–µ—Ç–µ–∫—Ü–∏–∏
            detectAccelerationPattern(match) {
                const deviation = match.total_deviation || 0;
                const minutes = match.minutes_elapsed || 0;
                return deviation > 2 && minutes > 6;
            }

            detectDivergencePattern(match) {
                return match.total_change_percent !== undefined && 
                       match.pace_change_percent !== undefined;
            }

            detectCompressionPattern(match) {
                const deviation = match.total_deviation || 0;
                return Math.abs(deviation) > 4;
            }

            // –≠–¢–ê–ü 3: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–∞–∑—ã –∏ —Å–∏–≥–Ω–∞–ª–∞
            determinePhase(match, analysis) {
                const { quality, failedFilters } = analysis.context;
                const { patterns, confidence } = analysis.patterns;

                console.log(`üéØ DeterminePhase: quality=${quality}, patterns=${patterns.length}, confidence=${confidence}`);

                // –ë–∞–∑–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è
                if (quality === 'LOW') {
                    return { phase: 'waiting', signal: 'none', confidence: 0 };
                }

                // –û–ü–†–ï–î–ï–õ–Ø–ï–ú –ù–ê–ü–†–ê–í–õ–ï–ù–ò–ï
                const deviation = match.total_deviation || 0;
                const isOverPotential = deviation > 2;
                const isUnderPotential = deviation < -2;

                console.log(`üìà –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: deviation=${deviation}, over=${isOverPotential}, under=${isUnderPotential}`);

                let phase = 'analysis';
                let signal = 'none';

                // –£–ñ–ï–°–¢–û–ß–ï–ù–ù–´–ï –ü–†–ê–í–ò–õ–ê
                if (confidence >= 70) {  // –£–∂–µ—Å—Ç–æ—á–µ–Ω–æ: –±—ã–ª–æ 60
                    signal = 'strong';
                    phase = isOverPotential ? 'over' : (isUnderPotential ? 'under' : 'analysis');
                } else if (confidence >= 55) {  // –£–∂–µ—Å—Ç–æ—á–µ–Ω–æ: –±—ã–ª–æ 40
                    signal = 'medium';
                    phase = isOverPotential ? 'over' : (isUnderPotential ? 'under' : 'analysis');
                } else if (confidence >= 35) {  // –£–∂–µ—Å—Ç–æ—á–µ–Ω–æ: –±—ã–ª–æ 20
                    signal = 'weak';
                }

                // –ï–°–õ–ò –ï–°–¢–¨ –û–¢–ö–õ–û–ù–ï–ù–ò–ï >15% - –°–ò–ì–ù–ê–õ –°–†–ï–î–ù–ò–ô (–£–∂–µ—Å—Ç–æ—á–µ–Ω–æ: –±—ã–ª–æ >10)
                if (Math.abs(deviation) > 15 && signal === 'none' && confidence > 15) {
                    signal = 'medium';
                    phase = isOverPotential ? 'over' : 'under';
                }

                console.log(`üéØ –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: phase=${phase}, signal=${signal}, confidence=${confidence}`);
                return { phase, signal, confidence };
            }

            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
            isBlowout(score) {
                if (!score || score === '-') return false;
                try {
                    const [home, away] = score.split(':').map(Number);
                    return Math.abs(home - away) > 20;
                } catch {
                    return false;
                }
            }

            isUnknownTournament(tournament) {
                const knownTournaments = ['–ï–í–†–û–õ–ò–ì–ê', '–ï–í–†–û–ö–£–ë–û–ö', 'NBA', 'VTB', 'ACB', '–õ–ß'];
                return !knownTournaments.some(known => tournament.includes(known));
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä
        const matchAnalyzer = new MatchAnalyzer();

        // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –º–∏–Ω—É—Ç –º–∞—Ç—á–∞ –∏–∑ –≤—Ä–µ–º–µ–Ω–∏
        function calculateMinutesElapsed(currentTime) {
            if (!currentTime || currentTime === '-') return 0;
            try {
                const parts = currentTime.split(':');
                if (parts.length < 2) return 0;
                const minutes = parseInt(parts[0]) || 0;
                const seconds = parseInt(parts[1]) || 0;
                return minutes + (seconds / 60);
            } catch (error) {
                return 0;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
        function updateTable(matches) {
            console.log('üîÑ updateTable called with', matches?.length, 'matches');
            
            if (!matches || matches.length === 0) {
                document.getElementById('matches-table').innerHTML = 
                    '<div class="loading">üì≠ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—Ç—á–µ–π –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç</div>';
                document.getElementById('stats').innerHTML = 
                    '–ú–∞—Ç—á–µ–π: 0 | –û–±–Ω–æ–≤–ª–µ–Ω–æ: ' + new Date().toLocaleTimeString();
                return;
            }

            document.getElementById('stats').innerHTML = 
                `üìä –ú–∞—Ç—á–µ–π: ${matches.length} | üîÑ ${new Date().toLocaleTimeString()}`;

            // –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ –ø–µ—Ä–≤–æ–≥–æ –º–∞—Ç—á–∞
            if (matches.length > 0) {
                console.log('üîç –ü–µ—Ä–≤—ã–π –º–∞—Ç—á –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:', matches[0]);
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>–ö–æ–º–∞–Ω–¥—ã / –¢—É—Ä–Ω–∏—Ä</th>
                            <th>–í—Ä–µ–º—è</th>
                            <th>–°—á–µ—Ç</th>
                            <th>–û—á–∫–∏</th>
                            <th>–ù–∞—á. —Ç–æ—Ç–∞–ª</th>
                            <th>–¢–µ–∫. —Ç–æ—Ç–∞–ª</th>
                            <th>–¢–µ–º–ø</th>
                            <th>–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ</th>
                            <th>–§–∞–∑–∞</th>
                            <th>–°–∏–≥–Ω–∞–ª</th>
                            <th>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            matches.forEach(match => {
                // –†–∞—Å—á–µ—Ç minutes_elapsed –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                if (!match.minutes_elapsed && match.current_time && match.current_time !== '-') {
                    match.minutes_elapsed = calculateMinutesElapsed(match.current_time);
                }
                
                // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Ç—á
                const contextAnalysis = matchAnalyzer.analyzeContext(match);
                const patternAnalysis = matchAnalyzer.detectPatterns(match);
                const phaseAnalysis = matchAnalyzer.determinePhase(match, {
                    context: contextAnalysis,
                    patterns: patternAnalysis
                });

                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç–æ–≤—É—é —Å—Ö–µ–º—É
                const rowClass = getRowClass(phaseAnalysis);
                const deviationClass = getDeviationClass(match.total_deviation);
                
                html += `
                    <tr class="${rowClass}" onclick="showMatchChart(${match.id}, '${escapeHtml(match.teams)}')">
                        <td>
                            <div class="match-teams">${match.teams}</div>
                            <div class="tournament">${match.tournament}</div>
                            ${contextAnalysis.failedFilters.length > 0 ? 
                                `<div class="negative" style="font-size: 10px; margin-top: 2px;">
                                    ‚ö†Ô∏è ${contextAnalysis.failedFilters.join(', ')}
                                </div>` : ''
                            }
                        </td>
                        <td><strong>${match.current_time}</strong></td>
                        <td><strong>${match.score}</strong></td>
                        <td>${match.total_points}</td>
                        <td>${match.initial_total || '-'}</td>
                        <td>${match.total_value || '-'}</td>
                        <td>${match.current_pace || '-'}</td>
                        <td>
                            <span class="${deviationClass}">
                                ${match.total_deviation ? `${match.total_deviation > 0 ? '+' : ''}${match.total_deviation}%` : '-'}
                            </span>
                        </td>
                        <td>
                            <span class="phase-${phaseAnalysis.phase}">
                                ${getPhaseIcon(phaseAnalysis.phase)} ${getPhaseText(phaseAnalysis.phase)}
                            </span>
                        </td>
                        <td>
                            ${phaseAnalysis.signal !== 'none' ? 
                                `<span class="signal-${phaseAnalysis.signal}">
                                    ${getSignalText(phaseAnalysis.signal)}
                                </span>` : 
                                '<span class="signal-none">-</span>'
                            }
                        </td>
                        <td>
                            <div style="font-size: 12px; font-weight: bold; color: #2c3e50;">
                                ${phaseAnalysis.confidence}%
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-fill ${getConfidenceClass(phaseAnalysis.confidence)}" 
                                    style="width: ${phaseAnalysis.confidence}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('matches-table').innerHTML = html;
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function getRowClass(analysis) {
            if (analysis.phase === 'over') return 'tr-quality';
            if (analysis.phase === 'under') return 'tr-caution';
            if (analysis.signal === 'weak') return 'tr-waiting';
            if (analysis.phase === 'waiting') return 'tr-waiting';
            return '';
        }

        function getPhaseIcon(phase) {
            const icons = {
                'analysis': 'üìä',
                'over': 'üü¢', 
                'under': 'üî¥',
                'waiting': '‚ö™'
            };
            return icons[phase] || 'üìä';
        }

        function getPhaseText(phase) {
            const texts = {
                'analysis': '–ê–Ω–∞–ª–∏–∑',
                'over': 'OVER',
                'under': 'UNDER', 
                'waiting': '–û–∂–∏–¥–∞–Ω–∏–µ'
            };
            return texts[phase] || '–ê–Ω–∞–ª–∏–∑';
        }

        function getSignalText(signal) {
            const texts = {
                'strong': '–°–∏–ª—å–Ω—ã–π',
                'medium': '–°—Ä–µ–¥–Ω–∏–π',
                'weak': '–°–ª–∞–±—ã–π',
                'none': '–ù–µ—Ç'
            };
            return texts[signal] || '–ù–µ—Ç';
        }

        function getConfidenceClass(confidence) {
            if (confidence >= 70) return 'confidence-high';
            if (confidence >= 40) return 'confidence-medium';
            return 'confidence-low';
        }

        function getDeviationClass(deviation) {
            if (!deviation) return 'neutral';
            if (deviation > 5) return 'positive';
            if (deviation < -5) return 'negative';
            return 'neutral';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            const socket = new WebSocket(wsUrl);
            
            socket.onopen = function() {
                console.log('‚úÖ WebSocket connected');
                wsConnected = true;
                window.wsConnected = true;
                document.getElementById('stats').innerHTML = 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ | –û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...';
            };
            
            socket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === "table_update") {
                        updateTable(data.data.matches);
                        updateOpenChart(data.data.matches);
                    }
                } catch (error) {
                    console.error('‚ùå Error parsing WebSocket message:', error);
                }
            };

            socket.onclose = function() {
                console.log('‚ùå WebSocket disconnected');
                wsConnected = false;
                window.wsConnected = false;
                document.getElementById('stats').innerHTML = 'üü° –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                setTimeout(connectWebSocket, 5000);
            };

            socket.onerror = function(error) {
                console.error('‚ùå WebSocket error:', error);
            };
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–µ)
        function updateOpenChart(matches) {
            if (!currentOpenMatchId || !currentChart) return;
            const currentMatch = matches.find(match => match.id === currentOpenMatchId);
            if (currentMatch) {
                updateChartData(currentOpenMatchId, currentMatch);
            }
        }

        function updateChartData(matchId, matchData) {
            fetch(`/api/matches/${matchId}/chart`)
                .then(response => response.json())
                .then(data => {
                    if (!data.error) {
                        refreshChart(data);
                        updateChartTitle(matchData);
                    }
                })
                .catch(error => console.error('‚ùå Error updating chart:', error));
        }

        function refreshChart(newData) {
            if (!currentChart || !newData.timestamps) return;
            window.currentChartData = newData;
            currentChart.data.labels = newData.timestamps;
            currentChart.data.datasets[0].data = newData.total_points;
            currentChart.data.datasets[1].data = newData.total_values;
            currentChart.data.datasets[2].data = newData.pace_data;
            currentChart.update('none');
        }

        function updateChartTitle(matchData) {
            const chartTitle = document.getElementById('chartTitle');
            if (chartTitle && matchData) {
                chartTitle.innerHTML = `
                    <div style="text-align: center; padding: 10px 0;">
                        <div style="font-size: 20px; font-weight: bold; color: #2c3e50; margin-bottom: 6px;">
                            ${matchData.teams}
                        </div>
                        <div style="font-size: 15px; color: #5d6d7e; margin-bottom: 4px;">
                            ${matchData.tournament}
                        </div>
                        <div style="font-size: 14px; color: #7f8c8d; background: #f8f9fa; padding: 4px 12px; border-radius: 12px; display: inline-block;">
                            ‚è±Ô∏è –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: <strong>${matchData.current_time}</strong>
                        </div>
                    </div>
                `;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–∞—Ç—á–µ
        function getMatchInfoByMatchId(matchId) {
            const rows = document.querySelectorAll('#matches-table tr');
            for (let row of rows) {
                const matchTeams = row.querySelector('.match-teams');
                if (matchTeams) {
                    const onclickAttr = row.getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes(`showMatchChart(${matchId},`)) {
                        const tournamentElement = row.querySelector('.tournament');
                        const timeElement = row.querySelector('td:nth-child(2) strong');
                        return {
                            tournament: tournamentElement ? tournamentElement.textContent : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç—É—Ä–Ω–∏—Ä',
                            currentTime: timeElement ? timeElement.textContent : '-',
                            teams: matchTeams.textContent
                        };
                    }
                }
            }
            return {
                tournament: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç—É—Ä–Ω–∏—Ä',
                currentTime: '-',
                teams: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã'
            };
        }

        function showMatchChart(matchId, teams) {
            currentOpenMatchId = matchId;
            const matchInfo = getMatchInfoByMatchId(matchId);
            
            fetch(`/api/matches/${matchId}/chart`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    
                    document.getElementById('chartTitle').innerHTML = `
                        <div style="text-align: center; padding: 10px 0;">
                            <div style="font-size: 20px; font-weight: bold; color: #2c3e50; margin-bottom: 6px;">
                                ${teams}
                            </div>
                            <div style="font-size: 15px; color: #5d6d7e; margin-bottom: 4px;">
                                ${matchInfo.tournament}
                            </div>
                            <div style="font-size: 14px; color: #7f8c8d; background: #f8f9fa; padding: 4px 12px; border-radius: 12px; display: inline-block;">
                                ‚è±Ô∏è –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: <strong>${matchInfo.currentTime}</strong>
                            </div>
                        </div>
                    `;
                    
                    createChart(data, teams, matchInfo.tournament, matchInfo.currentTime);
                    modal.style.display = 'block';
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞');
                });
        }

        function getCurrentValues(chartData) {
            if (!chartData || !chartData.total_points || chartData.total_points.length === 0) {
                return { totalPoints: '-', totalValue: '-', pace: '-' };
            }
            const lastIndex = chartData.total_points.length - 1;
            return {
                totalPoints: chartData.total_points[lastIndex] || '-',
                totalValue: chartData.total_values[lastIndex] || '-',
                pace: chartData.pace_data[lastIndex] || '-'
            };
        }

        function createChart(chartData, teams, tournament, currentTime) {
            const ctx = document.getElementById('matchChart').getContext('2d');
            if (currentChart) currentChart.destroy();
            
            window.currentChartData = chartData;
            const currentValues = getCurrentValues(chartData);
            
            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.timestamps,
                    datasets: [
                        {
                            label: `–û—á–∫–∏: ${currentValues.totalPoints}`,
                            data: chartData.total_points,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: `–õ–∏–Ω–∏—è —Ç–æ—Ç–∞–ª–∞: ${currentValues.totalValue}`,
                            data: chartData.total_values,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: `–¢–µ–º–ø –∏–≥—Ä—ã: ${currentValues.pace}`,
                            data: chartData.pace_data,
                            borderColor: 'rgb(153, 102, 255)',
                            backgroundColor: 'rgba(153, 102, 255, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointStyle: 'circle',
                            pointRadius: 3,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { 
                            title: { display: true, text: '–í—Ä–µ–º—è –º–∞—Ç—á–∞' },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' }
                        },
                        y: { 
                            title: { display: true, text: '–û—á–∫–∏ / –¢–µ–º–ø' },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    const timestamp = window.currentChartData.timestamps[index];
                                    const score = window.currentChartData.scores ? window.currentChartData.scores[index] : 'N/A';
                                    return `–í—Ä–µ–º—è: ${timestamp} | –°—á–µ—Ç: ${score}`;
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/api/matches')
                .then(response => response.json())
                .then(data => updateTable(data.matches))
                .catch(error => {
                    console.error('‚ùå Initial load error:', error);
                    document.getElementById('matches-table').innerHTML = 
                        '<div class="loading">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
                });

            connectWebSocket();
        });
    </script>
</body>
</html>